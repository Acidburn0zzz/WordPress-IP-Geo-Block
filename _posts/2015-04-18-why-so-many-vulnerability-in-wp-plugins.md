---
layout: post
title:  "Why so many vulnerability in WordPress plugins?"
date:   2015-04-18 00:00:00
categories: article
---

[![WordPress Vulnerability Statistics]({{ "/img/2015-04/vurlerability-statistics.png" | prepend: site.baseurl }}
  "WordPress Vulnerability Statistics by WPScan Vulnerability Database"
)][WPScan]

The above graph shows recent statistics of WordPress vulnerability from 
[WPScan Vulnerability Database][WPScan] analyzed by [Sucuri][Sucuri] which 
is a world wide security company especially famous for analyzing WordPress 
vulnerability.

Why so many vulnerabilities are there in WP plugins?

After reading the [Sucuri Blog][Sucuri-Blog] widely and deeply, I came to 
the conclusion that there are some specific reasons to developping WordPress 
plugins.

<!--more-->

### SQL Injection ###

On August 2014, Sururi team reported about 
[SQLi in Custom Contact Forms][Custom-Contact-Forms].

Here is the codes for administrators to dump SQL and download the backed up 
previous one.

{% highlight ruby %}
if (!is_admin()) { /* is front */
    ...
    $custom_contact_front = new CustomContactFormsFront();
    ...
} else { /* is admin */
    ...
    $custom_contact_admin = new CustomContactFormsAdmin();
    ...
    add_action('init', array(&$custom_contact_admin, 'adminInit'), 1);
}
 
function adminInit() {
    $this->downloadExportFile();
    $this->downloadCSVExportFile();
    $this->runImport();
}
{% endhighlight %}

This codes had at least next five issues.

1. Validate user role by `is_admin()`.
2. Lack for assumption of unexpected access route.
3. Export and import without validating privilege.
4. Export raw SQL to the client.
5. Import raw SQL from the client.

As a result, an attacker can easyly know the DB prefix set in the 
`wp-config.php` and upload some malicious SQL to exploit the site.

[![Vulnerability of Custom Contact Form]({{ "/img/2015-04/custom-contact-form.png" | prepend: site.baseurl }}
  "Vulnerability of Custom Contact Form"
)][Custom-Contact-Forms]

This is caused by misunderstanding of `is_admin()` which indicate always 
`true` when someone access the admin area even with no authentication.

To avoid this vulnerability, the developer must follow the 
[SQL Injection Prevention Cheat Sheet][OWASP-SQL] like below.

1. Validate user privilege by `current_user_can()` with `manage_options`.
2. Validate nonece to limit the access route.
3. Export and import validated and parameterized queries.
4. Use stored procedures.
5. Escape all user supplied input.

The action hook `admin_init` may cause similar misunderstanding. Sucuri reported 
related vulnerability of 
[RFI in MailPoet Plugin](https://blog.sucuri.net/2014/07/remote-file-upload-vulnerability-on-mailpoet-wysija-newsletters.html "WordPress Security Vuln in MailPoet Plugin | Sucuri Blog")
on July 1 2014, and
[RCE in Platform theme](https://blog.sucuri.net/2015/01/security-advisory-vulnerabilities-in-pagelinesplatform-theme-for-wordpress.html "Security Advisory - Vulnerabilities in Pagelines/Platform theme for WordPress - Public Preview | Sucuri Blog")
on Jan 21 2015.

### Privilege Escalation ###

On February 3 2015, Sucuri disclosed 
[PE in UpdraftPlus plugin](https://blog.sucuri.net/2015/02/advisory-dangerous-nonce-leak-in-updraftplus.html "Advisory - Dangerous &quot;nonce&quot; leak in UpdraftPlus | Sucuri Blog").

Suppose a registered user hit the button on the dashboard to do something.

{% highlight php %}
<form method="post" action="<?php echo admin_url( 'admin.php' ); ?>">
    <?php wp_nonce_field( 'foo-secret-nonce' ); ?>
    <input type="hidden" name="action" value="foo" />
    <input type="submit" value="Something to do" />
</form>
{% endhighlight %}

The function `foo_handler` will be triggered via action hook `admin_action_foo` 
when the request to `wp-admin/?action=foo` is sent by the following code.

{% highlight ruby %}
add_action( 'admin_action_foo', 'foo_handler' );
{% endhighlight %}

If the `foo-secret-nonce` is also used for an administrator function to do an 
important job and only `check_admin_referer('foo-secret-nonce')` is examined 
without validating the privilege, PE will happen.

The same vulnerability in WPtouch was also 
[disclosed on July 14, 2014](https://blog.sucuri.net/2014/07/disclosure-insecure-nonce-generation-in-wptouch.html "Disclosure: Insecure Nonce Generation in WPtouch | Sucuri Blog").

### CSRF ###

A cause of <abbr title="Cross Site Request Forgeries">CSRF</abbr> is simple.

For example, if you push "Save Changes" on the admin screen, the page 
transition happens after saving the setting data into the DB.
In a sequence of these process, if no nonce is on the page before transition 
or no validation of nonce before saving data, CSRF immediately occurs.

In this case, only validation of authentication or privilege at saving process 
can not prevent this vulnerability because an administrator potencially click 
a malicious link with own authorized cookie.

Such misunderstanding that it's enough to validate authentication and privilege 
[leads many plugins to this vulnerability](https://wpvulndb.com/search?text=&vuln_type=3).

### File Inclusion ###

<abbr title="File Inclusion">FI</abbr> (or Arbitrary File Download) is a 
vulnerability that occurs by giving the input where verification is not 
sufficient to a type of file system function such as `file_get_contents()`.

On September 2014, 
[a vulnerability of Slider Revolution][Slider-Revolution]
became a big topic. For certain functions for the administrators, an attack 
could download any files via like the following request to `admin-ajax.php`.

{% highlight text %}
http://example.com/wp-admin/admin-ajax.php?action=show-me&file=../wp-config.php
{% endhighlight %}

The request was handled like followings.

1. Always trigger a handler for an authorized user who has no privilege.
2. No validation of nonce.
3. No validation of giving input.

As a result, the attacker could easily download `wp-config.php`.

[![Vulnerability of Slider Revolution]({{ "/img/2015-04/revslider.png" | prepend: site.baseurl }}
  "Vulnerability of Slider Revolution"
)][Slider-Revolution]

We can find this kind of vulnerability in [HD FLV Player][HD-FLV-Player] on 
December 2014.

### XSS ###

Unfortunately, <abbr title="cross site scripting">XSS</abbr> is very popular 
in WordPress plugins. In many cases, this occur with insufficient validation 
of untrusted data which comes from the outside (including from the DB) and 
lack of an escape just before responding to the user agent. The later is a 
fundamental countermeasure.

I make corresponding "[XSS Prevention Cheat Sheet][OWASP-XSS]" in OWASP and 
"[Data Validation][Data-Validation]" in Codex.

<div class="table-responsive">
  <table class="table">
    <thead>
      <tr>
        <th>Context</th>
        <th>Code Sample</th>
        <th>Defense</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>HTML body</td>
        <td><samp>&lt;div&gt;<code>DATA</code>&lt;/div&gt;</samp></td>
        <td><code>esc_html()</code></td>
      </tr>
      <tr>
        <td>HTML attributes</td>
        <td><samp>&lt;input&hellip;value="<code>DATA</code>"&gt;</samp></td>
        <td><code>esc_attr()</code>, <code>sanitize_text_field()</code></td>
      </tr>
      <tr>
        <td>GET parameter</td>
        <td><samp>&lt;a href="&hellip;?value=<code>DATA</code>"&gt;&hellip;&lt;/a&gt;</samp></td>
        <td><code>esc_url()</code></td>
      </tr>
      <tr>
        <td>SRC/HREF attribute</td>
        <td><samp>&lt;iframe src="<code>DATA</code>" /&gt;</samp></td>
        <td><code>esc_url()</code></td>
      </tr>
      <tr>
        <td>JavaScript Variable</td>
        <td><samp>&lt;script&gt;foo('<code>DATA</code>');&lt;/script&gt;</samp></td>
        <td><code>esc_js()</code></td>
      </tr>
      <tr>
        <td>CSS Value</td>
        <td><samp>&lt;div style="width:<code>DATA</code>;"&gt;&hellip;&lt;/div&gt;</samp></td>
        <td>N/A</td>
      </tr>
    </tbody>
  </table>
</div>

It's also important 
"[Validating Sanitizing and Escaping User Data][Sanitizing-Escaping]"
to validate untrusted data along the context.

### Conclusion ###

I've learned a lot of things from [Sucuri Blog][Sucuri-Blog] and conclude 
followings as some knowledge of developing WordPress plugins and themes.

* Input has been contaminated.
* The DB has also been contaminated.
* Secret information may leak.
* Administrator privileges also may leak and be stolen.
* Attacks may come from unexpected route.
* Attacker actually doesn't access to the page.

[WPScan]: https://wpvulndb.com/statistics "WordPress Vulnerability Statistics"
[Sucuri]: https://sucuri.net/ "Sucuri Security - Website Protection, Malware Removal, and Blacklist Prevention"
[Sucuri-Blog]: https://blog.sucuri.net/ "Sucuri Blog"
[Custom-Contact-Forms]: https://blog.sucuri.net/2014/08/database-takeover-in-custom-contact-forms.html "Critical Vulnerability Disclosed on WordPress Custom Contact Forms Plugin | Sucuri Blog"
[Slider-Revolution]: https://blog.sucuri.net/2014/09/slider-revolution-plugin-critical-vulnerability-being-exploited.html "Slider Revolution Plugin Critical Vulnerability Being Exploited | Sucuri Blog"
[HD-FLV-Player]: https://blog.sucuri.net/2014/12/critical-vulnerability-in-joomla-hd-flv-player-plugin.html "Critical vulnerability affecting HD FLV Player | Sucuri Blog"
[OWASP-SQL]: https://www.owasp.org/index.php/SQL_Injection_Prevention_Cheat_Sheet#Introduction "SQL Injection Prevention Cheat Sheet"
[OWASP-XSS]: https://www.owasp.org/index.php/XSS_%28Cross_Site_Scripting%29_Prevention_Cheat_Sheet "XSS (Cross Site Scripting) Prevention Cheat Sheet - OWASP"
[Data-Validation]: http://codex.wordpress.org/Data_Validation "Data Validation &laquo; WordPress Codex"
[Sanitizing-Escaping]: http://codex.wordpress.org/Validating_Sanitizing_and_Escaping_User_Data "Validating Sanitizing and Escaping User Data &laquo; WordPress Codex"
[IP-Geo-Block]: https://wordpress.org/plugins/ip-geo-block/ "WordPress &#8250; IP Geo Block &laquo; WordPress Plugins"
