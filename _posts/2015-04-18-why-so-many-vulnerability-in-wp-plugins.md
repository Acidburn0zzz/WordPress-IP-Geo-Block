---
layout: post
title:  "Why so many vulnerability in WordPress plugins?"
date:   2015-04-18 00:00:00
categories: article
---

[![WordPress Vulnerability Statistics]({{ "/img/2015-04/vurlerability-statistics.png" | prepend: site.baseurl }}
  "WordPress Vulnerability Statistics by WPScan Vulnerability Database"
)][WPScan]

The above graph shows recent statistics of WordPress vulnerability from 
[WPScan Vulnerability Database][WPScan] analyzed by [Sucuri][Sucuri] which 
is a world wide security company especially famous for analyzing WordPress 
vulnerability.

Why so many vulnerabilities are there in WP plugins?

After reading the [Sucuri Blog][Sucuri-Blog] widely and deeply, I came to 
the conclusion that there are some specific reasons to developping WordPress 
plugins.

<!--more-->

### SQL Injection ###

On August 2014, Sururi team reported about 
[SQLi in Custom Contact Forms][Custom-Contact-Forms].

Here is the codes for administrators to dump SQL and download the backed up 
previous one.

{% highlight ruby %}
if (!is_admin()) { /* is front */
    ...
    $custom_contact_front = new CustomContactFormsFront();
    ...
} else { /* is admin */
    ...
    $custom_contact_admin = new CustomContactFormsAdmin();
    ...
    add_action('init', array(&$custom_contact_admin, 'adminInit'), 1);
}
 
function adminInit() {
    $this->downloadExportFile();
    $this->downloadCSVExportFile();
    $this->runImport();
}
{% endhighlight %}

This codes had at least next five issues.

1. Validate user role by `is_admin()`.
2. Lack for assumption of unexpected access route.
3. Export and import without validating privilege.
4. Export raw SQL to the client.
5. Import raw SQL from the client.

As a result, an attacker can easyly know the DB prefix set in the 
`wp-config.php` and upload some malicious SQL to exploit the site.

[![Vulnerability of Custom Contact Form]({{ "/img/2015-04/custom-contact-form.png" | prepend: site.baseurl }}
  "Vulnerability of Custom Contact Form"
)][Custom-Contact-Forms]

This is caused by misunderstanding of `is_admin()` which indicate always 
`true` when someone access the admin area even with no authentication.

To avoid this vulnerability, the developer must follow the 
[SQL Injection Prevention Cheat Sheet][OWASP-SQL] like below.

1. Validate user privilege by `current_user_can('manage_options')`.
2. Validate nonece to limit the access route.
3. Export and import validated and parameterized queries.
4. Use stored procedures.
5. Escape all user supplied input.

The action hook `admin_init` may cause similar misunderstanding. Sucuri reported 
related vulnerability of 
[RFI in MailPoet Plugin](https://blog.sucuri.net/2014/07/remote-file-upload-vulnerability-on-mailpoet-wysija-newsletters.html "WordPress Security Vuln in MailPoet Plugin | Sucuri Blog")
on July 1 2014, and
[RCE in Platform theme](https://blog.sucuri.net/2015/01/security-advisory-vulnerabilities-in-pagelinesplatform-theme-for-wordpress.html "Security Advisory - Vulnerabilities in Pagelines/Platform theme for WordPress - Public Preview | Sucuri Blog")
on Jan 21 2015.

### Privilege Escalation ###

On February 3 2015, Sucuri disclosed 
[PE in UpdraftPlus plugin](https://blog.sucuri.net/2015/02/advisory-dangerous-nonce-leak-in-updraftplus.html "Advisory - Dangerous &quot;nonce&quot; leak in UpdraftPlus | Sucuri Blog").

Suppose a registered user hit the button on the dashboard to do something.

{% highlight php %}
<form method="post" action="<?php echo admin_url( 'admin.php' ); ?>">
    <?php wp_nonce_field( 'foo-secret-nonce' ); ?>
    <input type="hidden" name="action" value="foo" />
    <input type="submit" value="Something to do" />
</form>
{% endhighlight %}

The function `foo_handler` will be triggered via action hook `admin_action_foo` 
when the request to `wp-admin/?action=foo` is sent by the following code.

{% highlight ruby %}
add_action( 'admin_action_foo', 'foo_handler' );
{% endhighlight %}

If the `foo-secret-nonce` is also used for an administrator function to do an 
important job and only `check_admin_referer('foo-secret-nonce')` is examined 
without validating the privilege, PE will happen.

[WPScan]: https://wpvulndb.com/statistics "WordPress Vulnerability Statistics"
[Sucuri]: https://sucuri.net/ "Sucuri Security - Website Protection, Malware Removal, and Blacklist Prevention"
[Sucuri-Blog]: https://blog.sucuri.net/ "Sucuri Blog"
[Custom-Contact-Forms]: https://blog.sucuri.net/2014/08/database-takeover-in-custom-contact-forms.html "Critical Vulnerability Disclosed on WordPress Custom Contact Forms Plugin"
[OWASP-SQL]: https://www.owasp.org/index.php/SQL_Injection_Prevention_Cheat_Sheet#Introduction "SQL Injection Prevention Cheat Sheet"
[IP-Geo-Block]: https://wordpress.org/plugins/ip-geo-block/ "WordPress &#8250; IP Geo Block &laquo; WordPress Plugins"
