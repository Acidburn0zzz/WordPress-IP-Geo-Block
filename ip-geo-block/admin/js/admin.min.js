/*!
 * Project: WordPress IP Geo Block
 * Copyright (c) 2015-2016 tokkonopapa (tokkonopapa@yahoo.com)
 * This software is released under the MIT License.
 */
var ip_geo_block_time=new Date;(function(a){function f(a){return a?a.toString().replace(/[&<>"']/g,function(a){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[a]}):""}function n(c,d){d?a("#ip-geo-block-"+c).addClass("ip-geo-block-loading"):a("#ip-geo-block-"+c).removeClass("ip-geo-block-loading")}function m(a,d){window.confirm(f(a))&&d()}function r(a,d){if(-1!==location.href.indexOf(a)){var l=f(a)+(d?"&"+f(d):"");"undefined"===typeof IP_GEO_BLOCK_ZEP?window.location.href=l:IP_GEO_BLOCK_ZEP.redirect(l)}}function h(c,d,l){c&&n(c,!0);d.action=IP_GEO_BLOCK.action;d.nonce=IP_GEO_BLOCK.nonce;a.post(IP_GEO_BLOCK.url,d).done(function(a,b,e){l(a)}).fail(function(a,b,e){window.alert(f(b+" "+a.responseText))}).always(function(){c&&n(c,!1)})}function q(a,d){h(a,{cmd:"clear-"+a,which:d},function(a){r(a.page,a.tab)})}function t(a){h(a,{cmd:a},function(a){r(a.page,a.tab)})}var u={self:this,drawChart:function(){this.drawPie();this.drawLine()},dataPie:null,viewPie:null,drawPie:function(){if(!self.dataPie){self.dataPie=new google.visualization.DataTable;self.dataPie.addColumn("string","Country");self.dataPie.addColumn("number","Requests");var c;a("#ip-geo-block-countries li").each(function(){c=a(this).text().split(":");self.dataPie.addRow([c[0]||"",Number(c[1])])})}self.viewPie||(self.viewPie=new google.visualization.PieChart(document.getElementById("ip-geo-block-chart-countries")));a("#ip-geo-block-chart-countries").width()&&self.viewPie.draw(self.dataPie,{backgroundColor:"#f1f1f1",chartArea:{left:0,top:"5%",width:"100%",height:"90%"},sliceVisibilityThreshold:.015})},dataLine:null,viewLine:null,drawLine:function(){if(!self.dataLine){self.dataLine=new google.visualization.DataTable;self.dataLine.addColumn("date","Date");self.dataLine.addColumn("number","comment");self.dataLine.addColumn("number","xmlrpc");self.dataLine.addColumn("number","login");self.dataLine.addColumn("number","admin");var c,d,f,h,b,e,k=[],p=a("#ip-geo-block-targets tr");c=0;for(h=p.length;c<h;c++)for(k[c]=[],e=p.eq(c).children(),d=0,b=e.length;d<b;d++)f=e.eq(d).text(),k[c].push(d?Number(f):new Date(f));self.dataLine.addRows(k)}self.viewLine||(self.viewLine=new google.visualization.LineChart(document.getElementById("ip-geo-block-chart-daily")));if(c=a("#ip-geo-block-chart-daily").width())c=320<c?!0:!1,self.viewLine.draw(self.dataLine,{backgroundColor:"#f1f1f1",legend:{position:"bottom"},hAxis:{format:"MM/dd"},vAxis:{textPosition:c?"out":"in"},chartArea:{left:c?"10%":0,top:"5%",width:"100%",height:"75%"}})}};a(function(){ip_geo_block_time=new Date-ip_geo_block_time;var c="undefined"!==typeof wpCookies&&wpCookies.getHash("ip-geo-block-admin")||{},d=/&tab=(\d)/.exec(window.location.href),d=Number(d&&d[1]),l=a('<fieldset class="ip-geo-block-field"></fieldset>'),n=a("<legend></legend>");a(".form-table").each(function(b){var e=a(this),k=e.prevAll("h2,h3:first"),p=k.nextUntil(e);e.wrap(l).parent().attr("id","ip-geo-block-settings-"+b).data("ip-geo-block",b).prepend(k.wrap(n).parent());p.insertBefore(e);1>=d&&(b+=d?8:0,"undefined"===typeof c[b]||c[b]?k.addClass("ip-geo-block-dropdown").parent().nextAll().show():k.addClass("ip-geo-block-dropup").parent().nextAll().hide())});if(1>=d)a("form").on("click","h2,h3",function(b){b=a(this);var e=b.closest("fieldset").data("ip-geo-block");b.parent().nextAll().toggle();b.toggleClass("ip-geo-block-dropup").toggleClass("ip-geo-block-dropdown");c[e+(d?8:0)]=b.hasClass("ip-geo-block-dropdown")?"o":"";wpCookies.setHash("ip-geo-block-admin",c);a("#ip-geo-block-chart-countries").length&&u.drawChart();return!1});a("#ip-geo-block-inhibit").on("submit",function(){return!1});switch(d){case 0:a("#ip-geo-block-scan-code").on("click",function(b){var e=a(this).parent();h("scanning",{cmd:"scan-code"},function(a){e.children("ul").length||e.append('<ul id="ip-geo-block-code-list"></ul>');e=e.children("ul").empty();var b,c;for(b in a)a.hasOwnProperty(b)&&(b=f(b),"string"===typeof a[b]?c=f(a[b]):(c=f(a[b].code),b='<abbr title="'+f(a[b].type)+'">'+b+"</abbr>"),e.append("<li>"+b+' : <span class="ip-geo-block-notice">'+c+"</span></li>"));e.show("slow")});return!1});a("#ip_geo_block_settings_matching_rule").on("change",function(){a("#ip_geo_block_settings_white_list").closest("tr").toggle("1"!==this.value);a("#ip_geo_block_settings_black_list").closest("tr").toggle("0"!==this.value);return!1}).trigger("change");a("#update").on("click",function(b){h("download",{cmd:"download"},function(b){var c,d,g;for(c in b)if(b.hasOwnProperty(c))for(d in g=b[c],g)g.hasOwnProperty(d)&&(d=f(d),g[d].filename&&a("#ip_geo_block_settings_"+c+"_"+d+"_path").val(f(g[d].filename)),g[d].message&&a("#ip_geo_block_"+c+"_"+d).text(f(g[d].message)))});return!1});a('select[name^="ip_geo_block_settings[validation]"]').on("change",function(b){var c;b=a(this);b.next(".ip_geo_block_settings_desc").empty();(c=b.children("option:selected").data("desc"))&&b.next(".ip_geo_block_settings_desc").html(a.parseHTML(c));return!1}).trigger("change");a("#create_table").on("click",function(a){m("Create table ?",function(){t("create_table")});return!1});a("#delete_table").on("click",function(a){m("Delete table ?",function(){t("delete_table")});return!1});break;case 1:a("#ip-geo-block-chart-countries").length&&"object"===typeof google&&google.load("visualization","1",{packages:["corechart"],callback:function(){u.drawChart()}});a("#clear_statistics").on("click",function(a){m("Clear statistics ?",function(){q("statistics",null)});return!1});a("#clear_cache").on("click",function(a){m("Clear cache ?",function(){q("cache",null)});return!1});break;case 2:a("#ip-geo-block-map").each(function(){a(this).GmapRS()});a("#get_location").on("click",function(b){var c=a("#ip_geo_block_settings_ip_address").val();c&&h("loading",{cmd:"search",ip:c,which:a("#ip_geo_block_settings_service").val()},function(b){var d,g="";for(d in b)b.hasOwnProperty(d)&&(d=f(d),g+='<li><span class="ip-geo-block-title">'+d+' : </span><span class="ip-geo-block-result">'+f(b[d])+"</span></li>");a("#ip-geo-block-map").GmapRS("addMarker",{latitude:b.latitude||0,longitude:b.longitude||0,title:c,content:"<ul>"+g+"</ul>",show:!0,zoom:8})});return!1});break;case 4:a(".ip-geo-block-log").hide().length&&h("logs",{cmd:"restore",which:null,time:ip_geo_block_time},function(b){for(var c in b)b.hasOwnProperty(c)&&(c=f(c),a("#ip-geo-block-log-"+c).html(b[c]));"function"===typeof a.fn.footable&&a(".ip-geo-block-log").fadeIn("slow").footable()}),a("#clear_logs").on("click",function(a){m("Clear logs ?",function(){q("logs",null)});return!1})}})})(jQuery);