/*
 * Project: WordPress IP Geo Block
 * Copyright (c) 2015 tokkonopapa (tokkonopapa@yahoo.com)
 * This software is released under the MIT License.
 */
var ip_geo_block_time=new Date;(function(a){function f(a){return a?a.toString().replace(/[&<>"']/g,function(a){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[a]}):""}function m(d,c){c?a("#ip-geo-block-"+d).addClass("ip-geo-block-loading"):a("#ip-geo-block-"+d).removeClass("ip-geo-block-loading")}function l(a,c){window.confirm(f(a))&&c()}function q(a,c){if(-1!==location.href.indexOf(a)){var h=f(a)+(c?"&"+f(c):"");"undefined"===typeof IP_GEO_BLOCK_ZEP?window.location.href=h:IP_GEO_BLOCK_ZEP.redirect(h)}}function k(d,c,h){d&&m(d,!0);c.action=IP_GEO_BLOCK.action;c.nonce=IP_GEO_BLOCK.nonce;a.post(IP_GEO_BLOCK.url,c).done(function(a,b,e){h(a)}).fail(function(a,b,e){window.alert(f(b+" "+a.responseText))}).always(function(){d&&m(d,!1)})}function p(a,c){k(a,{cmd:"clear-"+a,which:c},function(a){q(a.page,a.tab)})}function r(a){k(a,{cmd:a},function(a){q(a.page,a.tab)})}var t={self:this,drawChart:function(){this.drawPie()},dataPie:null,viewPie:null,drawPie:function(){if(!self.dataPie){self.dataPie=new google.visualization.DataTable;self.dataPie.addColumn("string","Country");self.dataPie.addColumn("number","Requests");var d;a("#ip-geo-block-countries li").each(function(){d=a(this).text().split(":");self.dataPie.addRow([d[0]||"",Number(d[1])])})}self.viewPie||(self.viewPie=new google.visualization.PieChart(document.getElementById("ip-geo-block-chart-countries")));a("#ip-geo-block-chart-countries").width()&&self.viewPie.draw(self.dataPie,{backgroundColor:"#f1f1f1",chartArea:{left:0,top:"5%",width:"100%",height:"90%"},sliceVisibilityThreshold:.015})}};a(function(){ip_geo_block_time=new Date-ip_geo_block_time;var d="undefined"!==typeof wpCookies&&wpCookies.getHash("ip-geo-block-admin")||{},c=/&tab=(\d)/.exec(window.location.href),c=Number(c&&c[1]),h=a('<fieldset class="ip-geo-block-field"></fieldset>'),m=a("<legend></legend>");a(".form-table").each(function(b){var e=a(this),n=e.prevAll("h2,h3:first"),g=n.nextUntil(e);e.wrap(h).parent().attr("id","ip-geo-block-settings-"+b).data("ip-geo-block",b).prepend(n.wrap(m).parent());g.insertBefore(e);1>=c&&(b+=c?8:0,"undefined"===typeof d[b]||d[b]?n.addClass("ip-geo-block-dropdown").parent().nextAll().show():n.addClass("ip-geo-block-dropup").parent().nextAll().hide())});if(1>=c)a("form").on("click","h2,h3",function(b){b=a(this);var e=b.closest("fieldset").data("ip-geo-block");b.parent().nextAll().toggle();b.toggleClass("ip-geo-block-dropup").toggleClass("ip-geo-block-dropdown");d[e+(c?8:0)]=b.hasClass("ip-geo-block-dropdown")?"o":"";wpCookies.setHash("ip-geo-block-admin",d);a("#ip-geo-block-chart-countries").length&&t.drawChart();return!1});a("#ip-geo-block-inhibit").on("submit",function(){return!1});switch(c){case 0:a("#ip-geo-block-scan-code").on("click",function(b){var e=a(this).parent();k("scanning",{cmd:"scan-code"},function(a){e.children("ul").length||e.append('<ul id="ip-geo-block-code-list"></ul>');e=e.children("ul").empty();var b,c;for(b in a)a.hasOwnProperty(b)&&(b=f(b),"string"===typeof a[b]?c=f(a[b]):(c=f(a[b].code),b='<abbr title="'+f(a[b].type)+'">'+b+"</abbr>"),e.append("<li>"+b+' : <span class="ip-geo-block-notice">'+c+"</span></li>"));e.show("slow")});return!1});a("#ip_geo_block_settings_matching_rule").on("change",function(){a("#ip_geo_block_settings_white_list").closest("tr").toggle("1"!==this.value);a("#ip_geo_block_settings_black_list").closest("tr").toggle("0"!==this.value);return!1}).trigger("change");a("#update").on("click",function(b){k("download",{cmd:"download"},function(b){var c,g,d;for(c in b)if(b.hasOwnProperty(c))for(g in d=b[c],d)d.hasOwnProperty(g)&&(g=f(g),d[g].filename&&a("#ip_geo_block_settings_"+c+"_"+g+"_path").val(f(d[g].filename)),d[g].message&&a("#ip_geo_block_"+c+"_"+g).text(f(d[g].message)))});return!1});a('select[name^="ip_geo_block_settings[validation]"]').on("change",function(b){var c;b=a(this);b.next(".ip_geo_block_settings_desc").empty();(c=b.children("option:selected").data("desc"))&&b.next(".ip_geo_block_settings_desc").html(a.parseHTML(c));return!1}).trigger("change");a("#create_table").on("click",function(a){l("Create table ?",function(){r("create_table")});return!1});a("#delete_table").on("click",function(a){l("Delete table ?",function(){r("delete_table")});return!1});break;case 1:a("#ip-geo-block-chart-countries").length&&"object"===typeof google&&google.load("visualization","1",{packages:["corechart"],callback:function(){t.drawChart()}});a("#show-hide-details").on("click",function(b){a("#ip-geo-block-countries").toggle();return!1});a("#clear_statistics").on("click",function(a){l("Clear statistics ?",function(){p("statistics",null)});return!1});a("#clear_cache").on("click",function(a){l("Clear cache ?",function(){p("cache",null)});return!1});break;case 2:a("#ip-geo-block-map").each(function(){a(this).GmapRS()});a("#get_location").on("click",function(b){var c=a("#ip_geo_block_settings_ip_address").val();c&&k("loading",{cmd:"search",ip:c,which:a("#ip_geo_block_settings_service").val()},function(b){var d,h="";for(d in b)b.hasOwnProperty(d)&&(d=f(d),h+='<li><span class="ip-geo-block-title">'+d+' : </span><span class="ip-geo-block-result">'+f(b[d])+"</span></li>");a("#ip-geo-block-map").GmapRS("addMarker",{latitude:b.latitude||0,longitude:b.longitude||0,title:c,content:"<ul>"+h+"</ul>",show:!0,zoom:8})});return!1});break;case 4:a(".ip-geo-block-log").hide().length&&k("logs",{cmd:"restore",which:null,time:ip_geo_block_time},function(b){for(var c in b)b.hasOwnProperty(c)&&(c=f(c),a("#ip-geo-block-log-"+c).html(b[c]));"function"===typeof a.fn.footable&&a(".ip-geo-block-log").fadeIn("slow").footable()}),a("#clear_logs").on("click",function(a){l("Clear logs ?",function(){p("logs",null)});return!1})}})})(jQuery);